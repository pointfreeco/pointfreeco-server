FROM swift:4.0

RUN swift --version

RUN apt-get update
RUN apt-get install -y postgresql libpq-dev

WORKDIR /app

COPY .build/dependencies-state.json ./.build/dependencies-state.json
COPY .env ./
COPY Packages ./Packages

COPY Makefile ./
RUN make install-cmark

COPY Package.swift ./
RUN swift package clean
RUN swift package reset
RUN OSS=1 swift package update

COPY Sources ./Sources
RUN OSS=1 swift build --configuration release

CMD ./.build/release/pointfreeco
